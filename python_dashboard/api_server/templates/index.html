<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/styles.css') }}?v=8">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-row">
            <div class="event-info">
                <h1 class="header-title" id="event-name">Loading...</h1>
                <span class="event-date" id="event-date"></span>
            </div>
            <div class="header-stats">
                <div class="hstat"><span class="hstat-val" id="stat-issued">0</span><span class="hstat-lbl">Q.Issued</span></div>
                <div class="hstat hstat-used"><span class="hstat-val" id="stat-q-used">0</span><span class="hstat-lbl">Q.Used</span></div>
                <div class="hstat hstat-remaining"><span class="hstat-val" id="stat-q-rem">0</span><span class="hstat-lbl">Q.Rem</span></div>
                <div class="hstat hstat-used"><span class="hstat-val" id="stat-c-used">0</span><span class="hstat-lbl">C.Used</span></div>
                <div class="hstat hstat-remaining"><span class="hstat-val" id="stat-c-rem">0</span><span class="hstat-lbl">C.Rem</span></div>
                <div class="hstat hstat-pistol"><span class="hstat-val" id="stat-pistols">0</span><span class="hstat-lbl">Pistols</span></div>
            </div>
            <div class="header-devices">
                <div class="header-leds-label"><span id="panel-online">0</span>/<span id="panel-total">0</span></div>
                <div id="device-leds" class="device-leds"></div>
            </div>
            <div class="header-servers">
                <div class="header-servers-label">Servers</div>
                <div id="server-leds" class="server-leds"></div>
            </div>
            <div class="header-actions">
                <button id="notification-bell" class="header-btn" title="Enable push notifications">&#128276;</button>
                <button id="search-toggle" class="header-btn" title="Search ticket">&#128269;</button>
                <div class="live-indicator">
                    <span class="live-dot"></span>
                    <span class="live-text">Live</span>
                </div>
            </div>
        </div>
        <!-- Collapsible search bar -->
        <div id="search-bar" class="search-bar hidden">
            <input type="text" id="ticket-search" class="search-input" placeholder="Search or validate ticket..." autocomplete="off">
            <button id="search-btn" class="search-button" title="Search">&#128269;</button>
            <button id="scan-btn" class="scan-button" title="Scan barcode with camera">&#128247;</button>
        </div>
    </header>

    <!-- Toast Notifications Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Camera Scanner Overlay -->
    <div id="scanner-overlay" class="scanner-overlay hidden">
        <div class="scanner-header">
            <span class="scanner-title">Scan Barcode</span>
            <button id="scanner-close" class="scanner-close-btn">&times;</button>
        </div>
        <div id="scanner-reader" class="scanner-reader"></div>
        <div class="scanner-hint">Point the camera at a barcode</div>
    </div>

    <!-- Main Grid -->
    <main class="main-container">
        <div id="turnstile-grid"></div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="connection-status" id="connection-status">
            <span class="connection-dot connected"></span>
            <span class="connection-text">Connected</span>
        </div>
        <span class="footer-info" id="stat-online">0 online</span>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script type="text/javascript" charset="utf-8">
        var socket = io();
        socket.on('connect', function() {
            socket.emit('my event', {data: 'I\'m connected!'});
        });

        // Listen for ticket validation events
        socket.on('ticket_validated', function(data) {
            showTicketToast(data);
            if (data.status === 'success') {
                flashDeviceCard(data.deviceName);
            }
        });

        // Listen for blade status changes via Socket.IO (instant update on card)
        socket.on('turnstile_status', function(data) {
            const cards = document.querySelectorAll('.turnstile-card');
            cards.forEach(card => {
                const title = card.querySelector('.card-title');
                if (title && title.textContent === data.device) {
                    const badge = card.querySelector('.status-badge');
                    badge.textContent = data.status;
                    badge.className = 'status-badge ' + data.status;
                    card.classList.remove('locked', 'unlocked');
                    card.classList.add(data.status);
                }
            });
        });

        // Show toast notification for ticket events
        function showTicketToast(data) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const statusClass = data.status === 'success' ? 'toast-success' :
                                data.status === 'already_used' ? 'toast-warning' : 'toast-error';
            const statusIcon = data.status === 'success' ? '&#10003;' :
                               data.status === 'already_used' ? '&#9888;' : '&#10007;';

            toast.className = `toast ${statusClass}`;
            toast.innerHTML = `
                <span class="toast-icon">${statusIcon}</span>
                <div class="toast-content">
                    <span class="toast-device">${data.deviceName || data.device}</span>
                    <span class="toast-message">${data.message || data.status}</span>
                </div>
            `;

            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('toast-fade-out');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // Flash device card on successful validation (no-op, blink effects removed)
        function flashDeviceCard(deviceName) {}
    </script>
    <script>
        const url = '/dashboard-data';
        let prevState = {}; // Track previous device state for change detection

        // Detect device state changes and show alerts
        function checkDeviceAlerts(turnstiles) {
            turnstiles.forEach(t => {
                const prev = prevState[t.name];
                if (!prev) return; // Skip first poll

                const h = t.health || {};
                const ph = prev.health || {};

                // Device went offline
                if (prev.online && !t.online) {
                    showAlertToast(t.name, 'Device OFFLINE', 'error');
                }
                // Device came back online
                if (!prev.online && t.online) {
                    showAlertToast(t.name, 'Device back online', 'success');
                }
                // Scanner disconnected
                if (ph.scanner && !h.scanner) {
                    showAlertToast(t.name, 'Scanner disconnected', 'error');
                }
                // Scanner reconnected
                if (!ph.scanner && h.scanner) {
                    showAlertToast(t.name, 'Scanner reconnected', 'success');
                }
                // Display disconnected
                if (ph.display && !h.display) {
                    showAlertToast(t.name, 'Display disconnected', 'warning');
                }
                // Network error
                if (ph.network && !h.network) {
                    showAlertToast(t.name, 'Network error', 'error');
                }
                // Blades unlocked/locked - now handled via Socket.IO (turnstile_status event)
                // Polling is too slow to catch the transient unlock/lock cycle
            });

            // Save current state
            turnstiles.forEach(t => {
                prevState[t.name] = { online: t.online, status: t.status, health: Object.assign({}, t.health || {}) };
            });
        }

        function showAlertToast(device, message, level) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const cls = level === 'success' ? 'toast-success' : level === 'warning' ? 'toast-warning' : 'toast-error';
            const icon = level === 'success' ? '&#10003;' : level === 'warning' ? '&#9888;' : '&#9888;';

            toast.className = `toast ${cls}`;
            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <div class="toast-content">
                    <span class="toast-device">${device}</span>
                    <span class="toast-message">${message}</span>
                </div>
            `;

            container.appendChild(toast);
            // Alert toasts stay longer (8s)
            setTimeout(() => {
                toast.classList.add('toast-fade-out');
                setTimeout(() => toast.remove(), 300);
            }, 8000);
        }

        // Update summary statistics
        function updateStats(data) {
            // Quentro stats: issued from Socket.IO, used from API, remaining = issued - used
            var qIssued = data.quentro ? Number(data.quentro.issued) : 0;
            var qUsed = data.stats.quentroUsed || 0;
            var qRem = qIssued - qUsed;
            document.getElementById('stat-issued').textContent = qIssued.toLocaleString();
            document.getElementById('stat-q-used').textContent = qUsed.toLocaleString();
            document.getElementById('stat-q-rem').textContent = qRem.toLocaleString();

            // Collaborator stats from API
            document.getElementById('stat-c-used').textContent = (data.stats.collaboratorUsed || 0).toLocaleString();
            document.getElementById('stat-c-rem').textContent = (data.stats.collaboratorRemaining || 0).toLocaleString();

            // Local stats
            const pistols = data.turnstiles.filter(t => t.pistol === 'On' && t.online).length;
            document.getElementById('stat-pistols').textContent = pistols;

            // Online devices count
            const online = data.turnstiles.filter(t => t.online).length;
            document.getElementById('stat-online').textContent = online + ' online';

            // Update device LED panel
            updateDevicePanel(data.turnstiles);

            // Update server LED panel
            updateServerPanel(data.servers);

            // Update event info
            if (data.event) {
                document.getElementById('event-name').textContent = data.event.showName || data.event.nombre;
                document.getElementById('event-date').textContent = new Date(data.event.fecha).toLocaleDateString();
            }
        }

        // Update device LED panel
        function updateDevicePanel(turnstiles) {
            const panel = document.getElementById('device-leds');
            const onlineCount = turnstiles.filter(t => t.online).length;
            document.getElementById('panel-online').textContent = onlineCount;
            document.getElementById('panel-total').textContent = turnstiles.length;

            panel.innerHTML = turnstiles.map(t => `
                <div class="device-led ${t.online ? 'online' : 'offline'}" title="${t.name}: ${t.online ? 'Online' : 'Offline'}">
                    <span class="led-dot"></span>
                    <span class="led-name">${t.name.replace('moli', '')}</span>
                </div>
            `).join('');
        }

        // Update server LED panel
        let prevServerState = {};
        function updateServerPanel(servers) {
            if (!servers) return;
            const panel = document.getElementById('server-leds');
            panel.innerHTML = servers.map(s => {
                const m = s.metrics || {};
                const hasMetrics = m.cpuPercent !== undefined;
                let tooltip = `${s.name} (${s.ip}): ${s.online ? 'Online' : 'Offline'}`;
                if (s.online) tooltip += `\nResponse: ${s.response_time_ms}ms`;
                if (hasMetrics) tooltip += `\nCPU: ${Math.round(m.cpuPercent)}% | Mem: ${Math.round(m.memoryPercent)}% | Disk: ${Math.round(m.diskPercent)}%`;
                return `<div class="server-led ${s.online ? 'online' : 'offline'}" title="${tooltip}">
                    <span class="led-dot"></span>
                    <span class="led-name">${s.name}</span>
                </div>`;
            }).join('');
        }

        function checkServerAlerts(servers) {
            if (!servers) return;
            servers.forEach(s => {
                const prev = prevServerState[s.name];
                if (!prev) return;
                if (prev.online && !s.online) {
                    showAlertToast(s.name, 'Server OFFLINE', 'error');
                }
                if (!prev.online && s.online) {
                    showAlertToast(s.name, 'Server back online', 'success');
                }
            });
            servers.forEach(s => {
                prevServerState[s.name] = { online: s.online };
            });
        }

        // Format last seen time
        function formatLastSeen(isoString) {
            if (!isoString) return 'Never';
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);

            if (diffSec < 60) return `${diffSec}s ago`;
            if (diffSec < 3600) return `${Math.floor(diffSec / 60)}m ago`;
            if (diffSec < 86400) return `${Math.floor(diffSec / 3600)}h ago`;
            return date.toLocaleDateString();
        }

        // Send remote command to device
        function sendCommand(device, command) {
            const cmdNames = {
                'reboot': 'REBOOT',
                'shutdown': 'SHUTDOWN',
                'restart_service': 'RESTART SERVICE',
                'lcd_init': 'REINIT LCD'
            };
            if (!confirm(`Send ${cmdNames[command] || command} to ${device}?`)) return;

            fetch(`/api/commands/${device}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({command})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(err => alert('Failed to send command: ' + err));
        }

        // Create turnstile card element
        function createTurnstileCard(moli, gateLbl) {
            const card = document.createElement('div');
            card.dataset.device = moli.name;
            updateTurnstileCard(card, moli, gateLbl);
            return card;
        }

        // Update an existing card's content without destroying it
        function updateTurnstileCard(card, moli, gateLbl) {
            const statusClass = moli.status === 'locked' ? 'locked' : 'unlocked';
            const pistolActive = moli.pistol === 'On';
            const isOnline = moli.online;
            const health = moli.health || {};

            card.className = `turnstile-card ${statusClass}${isOnline ? '' : ' offline'}`;
            card.innerHTML = `
                ${gateLbl ? `<span class="card-gate-label">${gateLbl}</span>` : ''}
                <div class="card-header">
                    <h3 class="card-title">${moli.friendlyName || moli.name}</h3>
                    <span class="status-badge ${statusClass}">${moli.status}</span>
                </div>
                <div class="card-body">
                    <div class="card-row">
                        <span class="card-label">Pistol</span>
                        <span class="pistol-indicator ${pistolActive ? 'active' : ''}">
                            <span class="pistol-dot"></span>
                            ${moli.pistol}
                        </span>
                    </div>
                    <div class="card-row">
                        <span class="card-label">Codes</span>
                        <span class="codes-value">${moli.codes.toLocaleString()}</span>
                    </div>
                    <div class="health-indicators">
                        <span class="health-chip ${health.scanner ? 'ok' : 'error'}" title="Scanner ${health.scanner ? 'Connected' : 'Disconnected'}">SCN</span>
                        ${health.scanner_disconnects > 0 ? `<span class="health-warn" title="Disconnects: ${health.scanner_disconnects}, Reconnects: ${health.scanner_reconnects}">! ${health.scanner_disconnects}</span>` : ''}
                        <span class="health-chip ${health.display ? 'ok' : 'error'}" title="Display ${health.display ? 'Connected' : 'Disconnected'}">LCD</span>
                        <span class="health-chip ${health.network ? 'ok' : 'error'}" title="Network ${health.network ? 'OK' : 'Error'}">NET</span>
                        ${health.cpu !== undefined ? `<span class="health-cpu" title="CPU Usage">${Math.round(health.cpu)}%</span>` : ''}
                        ${health.temperature ? `<span class="health-temp" title="Temperature">${health.temperature}&deg;C</span>` : ''}
                        <span class="health-time" title="Last update">${formatLastSeen(health.last_seen)}</span>
                    </div>
                </div>
                <div class="card-actions">
                    <button onclick="sendCommand('${moli.name}', 'reboot')" title="Reboot Device">PWR</button>
                    <button onclick="sendCommand('${moli.name}', 'restart_service')" title="Restart Service">RST</button>
                    <button onclick="sendCommand('${moli.name}', 'lcd_init')" title="Reinit LCD">LCD</button>
                    <button onclick="sendCommand('${moli.name}', 'shutdown')" class="btn-danger" title="Shutdown">OFF</button>
                </div>
            `;
        }

        // Update connection status
        function setConnectionStatus(connected, apiOnline, message = '') {
            const statusEl = document.getElementById('connection-status');
            const dot = statusEl.querySelector('.connection-dot');
            const text = statusEl.querySelector('.connection-text');

            if (connected) {
                dot.className = 'connection-dot connected';
                text.textContent = apiOnline ? 'Connected' : 'API Offline';
            } else {
                dot.className = 'connection-dot disconnected';
                text.textContent = message || 'Disconnected';
            }
        }

        let gridBuilt = false;

        // Build grid layout once (first load)
        function buildGrid(data) {
            const grid = document.getElementById('turnstile-grid');
            grid.innerHTML = '';

            const groups = {};
            data.turnstiles.forEach(moli => {
                const gate = moli.gate || 'Sin Puerta';
                if (!groups[gate]) groups[gate] = [];
                groups[gate].push(moli);
            });

            const sorted = Object.keys(groups).sort((a, b) => {
                const countA = groups[a].reduce((sum, t) => sum + (t.codes || 0), 0);
                const countB = groups[b].reduce((sum, t) => sum + (t.codes || 0), 0);
                return countB - countA;
            });

            const multiGates = sorted.filter(g => groups[g].length > 2);
            const singleGates = sorted.filter(g => groups[g].length <= 2);

            multiGates.forEach(gateName => {
                const gateCount = groups[gateName].reduce((sum, t) => sum + (t.codes || 0), 0);
                const section = document.createElement('div');
                section.className = 'gate-section';
                section.dataset.gate = gateName;
                section.innerHTML = `<div class="gate-header">
                    <span class="gate-name">${gateName}</span>
                    <span class="gate-count">${gateCount.toLocaleString()}</span>
                </div>`;
                const gateGrid = document.createElement('div');
                gateGrid.className = 'turnstile-grid';
                groups[gateName].forEach(moli => {
                    gateGrid.appendChild(createTurnstileCard(moli));
                });
                section.appendChild(gateGrid);
                grid.appendChild(section);
            });

            if (singleGates.length > 0) {
                const section = document.createElement('div');
                section.className = 'gate-section';
                const gateGrid = document.createElement('div');
                gateGrid.className = 'turnstile-grid';
                singleGates.forEach(gateName => {
                    groups[gateName].forEach(moli => {
                        gateGrid.appendChild(createTurnstileCard(moli, gateName));
                    });
                });
                section.appendChild(gateGrid);
                grid.appendChild(section);
            }

            gridBuilt = true;
        }

        // Update existing cards in-place (no DOM rebuild)
        function updateGrid(data) {
            // Update gate counts
            const groups = {};
            data.turnstiles.forEach(moli => {
                const gate = moli.gate || 'Sin Puerta';
                if (!groups[gate]) groups[gate] = [];
                groups[gate].push(moli);
            });

            document.querySelectorAll('.gate-section[data-gate]').forEach(section => {
                const gateName = section.dataset.gate;
                if (groups[gateName]) {
                    const countEl = section.querySelector('.gate-count');
                    if (countEl) {
                        const total = groups[gateName].reduce((sum, t) => sum + (t.codes || 0), 0);
                        countEl.textContent = total.toLocaleString();
                    }
                }
            });

            // Update each card by data-device attribute
            data.turnstiles.forEach(moli => {
                const card = document.querySelector(`.turnstile-card[data-device="${moli.name}"]`);
                if (card) {
                    const gateLbl = card.querySelector('.card-gate-label');
                    updateTurnstileCard(card, moli, gateLbl ? gateLbl.textContent : null);
                }
            });
        }

        // Fetch and render data
        function fetchData() {
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Network error');
                    return response.json();
                })
                .then(data => {
                    setConnectionStatus(true, data.apiOnline);
                    updateStats(data);
                    checkDeviceAlerts(data.turnstiles);
                    checkServerAlerts(data.servers);

                    if (!gridBuilt) {
                        buildGrid(data);
                    } else {
                        updateGrid(data);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    setConnectionStatus(false, false, 'Connection Error');
                });
        }

        // Initial fetch and start polling
        fetchData();
        setInterval(fetchData, 1000);
    </script>
    <script>
        // Ticket search functionality
        const ticketInput = document.getElementById('ticket-search');
        const searchBtn = document.getElementById('search-btn');
        function validateTicket() {
            const ticketCode = ticketInput.value.trim();
            console.log(ticketCode);
            if (!ticketCode) return;

            fetch(`/api/ticket`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ticket: ticketCode})
            })
            .then(r => r.json())
            .then(data => {
                showTicketToast(data);
                if (data.status === 'success') {
                    flashDeviceCard(data.deviceName || data.device);
                }
                ticketInput.value = '';
                ticketInput.focus();
            })
            .catch(err => {
                showTicketToast({
                    status: 'error',
                    message: 'Failed to validate ticket',
                    deviceName: 'System'
                });
            });
        }

        searchBtn.addEventListener('click', validateTicket);
        ticketInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') validateTicket();
        });

        // Toggle search bar
        document.getElementById('search-toggle').addEventListener('click', function() {
            const bar = document.getElementById('search-bar');
            bar.classList.toggle('hidden');
            if (!bar.classList.contains('hidden')) {
                document.getElementById('ticket-search').focus();
            }
        });
    </script>
    <script>
        // Camera barcode scanner
        const scanBtn = document.getElementById('scan-btn');
        const scannerOverlay = document.getElementById('scanner-overlay');
        const scannerClose = document.getElementById('scanner-close');
        let html5QrCode = null;

        function stopScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                }).catch(() => {});
            }
            scannerOverlay.classList.add('hidden');
        }

        function startScanner() {
            scannerOverlay.classList.remove('hidden');
            html5QrCode = new Html5Qrcode('scanner-reader');

            html5QrCode.start(
                { facingMode: 'environment' },
                {
                    fps: 10,
                    qrbox: { width: 300, height: 150 },
                    formatsToSupport: [
                        Html5QrcodeSupportedFormats.CODE_128,
                        Html5QrcodeSupportedFormats.CODE_39,
                        Html5QrcodeSupportedFormats.EAN_13,
                        Html5QrcodeSupportedFormats.EAN_8,
                        Html5QrcodeSupportedFormats.UPC_A,
                        Html5QrcodeSupportedFormats.UPC_E,
                        Html5QrcodeSupportedFormats.QR_CODE,
                        Html5QrcodeSupportedFormats.CODE_93,
                        Html5QrcodeSupportedFormats.ITF,
                    ]
                },
                (decodedText) => {
                    stopScanner();
                    ticketInput.value = decodedText;
                    validateTicket();
                },
                () => {}
            ).catch((err) => {
                stopScanner();
                showTicketToast({
                    status: 'error',
                    message: 'Camera access denied or not available',
                    deviceName: 'Scanner'
                });
            });
        }

        scanBtn.addEventListener('click', startScanner);
        scannerClose.addEventListener('click', stopScanner);
    </script>
    <script src="{{ url_for('static', filename='js/push-manager.js') }}"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/styles.css') }}?v=3">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="event-info">
                <h1 class="header-title" id="event-name">Loading...</h1>
                <span class="event-date" id="event-date"></span>
            </div>
            <div class="live-indicator">
                <span class="live-dot"></span>
                <span class="live-text">Live</span>
            </div>
        </div>
    </header>

    <!-- Toast Notifications Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Search Section -->
    <section class="search-section">
        <div class="search-container">
            <input 
                type="text" 
                id="ticket-search" 
                class="search-input" 
                placeholder="Search or validate ticket..."
                autocomplete="off"
            >
            <button id="search-btn" class="search-button" title="Search">üîç</button>
        </div>
    </section>

    <!-- Stats Bar -->
    <section class="stats-bar">
        <div class="stat-card">
            <span class="stat-value" id="stat-total">0</span>
            <span class="stat-label">Total Tickets</span>
        </div>
        <div class="stat-card stat-unlocked">
            <span class="stat-value" id="stat-used">0</span>
            <span class="stat-label">Used</span>
        </div>
        <div class="stat-card stat-locked">
            <span class="stat-value" id="stat-remaining">0</span>
            <span class="stat-label">Remaining</span>
        </div>
        <div class="stat-card stat-pistol">
            <span class="stat-value" id="stat-pistols">0</span>
            <span class="stat-label">Active Pistols</span>
        </div>
        <div class="stat-card stat-online">
            <span class="stat-value" id="stat-online">0</span>
            <span class="stat-label">Online</span>
        </div>
    </section>

    <!-- Main Grid -->
    <main class="main-container">
        <div id="turnstile-grid" class="turnstile-grid"></div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="connection-status" id="connection-status">
            <span class="connection-dot connected"></span>
            <span class="connection-text">Connected</span>
        </div>
        <span class="footer-info">Polling every 1s</span>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
    <script type="text/javascript" charset="utf-8">
        var socket = io();
        socket.on('connect', function() {
            socket.emit('my event', {data: 'I\'m connected!'});
        });

        // Listen for ticket validation events
        socket.on('ticket_validated', function(data) {
            showTicketToast(data);
            if (data.status === 'success') {
                flashDeviceCard(data.deviceName);
            }
        });

        // Show toast notification for ticket events
        function showTicketToast(data) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const statusClass = data.status === 'success' ? 'toast-success' :
                                data.status === 'already_used' ? 'toast-warning' : 'toast-error';
            const statusIcon = data.status === 'success' ? '&#10003;' :
                               data.status === 'already_used' ? '&#9888;' : '&#10007;';

            toast.className = `toast ${statusClass}`;
            toast.innerHTML = `
                <span class="toast-icon">${statusIcon}</span>
                <div class="toast-content">
                    <span class="toast-device">${data.deviceName || data.device}</span>
                    <span class="toast-message">${data.message || data.status}</span>
                </div>
            `;

            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('toast-fade-out');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // Flash device card on successful validation
        function flashDeviceCard(deviceName) {
            const cards = document.querySelectorAll('.turnstile-card');
            cards.forEach(card => {
                const title = card.querySelector('.card-title');
                if (title && title.textContent === deviceName) {
                    card.classList.add('state-changed');
                    setTimeout(() => card.classList.remove('state-changed'), 500);
                }
            });
        }
    </script>
    <script>
        const url = '/dashboard-data';
        let previousState = {};

        // Update summary statistics
        function updateStats(data) {
            // Event stats from API
            document.getElementById('stat-total').textContent = data.stats.totalTickets.toLocaleString();
            document.getElementById('stat-used').textContent = data.stats.usedTickets.toLocaleString();
            document.getElementById('stat-remaining').textContent = data.stats.remainingTickets.toLocaleString();

            // Local stats
            const pistols = data.turnstiles.filter(t => t.pistol === 'On').length;
            document.getElementById('stat-pistols').textContent = pistols;

            // Online devices count
            const online = data.turnstiles.filter(t => t.online).length;
            document.getElementById('stat-online').textContent = online;

            // Update event info
            if (data.event) {
                document.getElementById('event-name').textContent = data.event.showName || data.event.nombre;
                document.getElementById('event-date').textContent = new Date(data.event.fecha).toLocaleDateString();
            }
        }

        // Format last seen time
        function formatLastSeen(isoString) {
            if (!isoString) return 'Never';
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);

            if (diffSec < 60) return `${diffSec}s ago`;
            if (diffSec < 3600) return `${Math.floor(diffSec / 60)}m ago`;
            if (diffSec < 86400) return `${Math.floor(diffSec / 3600)}h ago`;
            return date.toLocaleDateString();
        }

        // Send remote command to device
        function sendCommand(device, command) {
            const cmdNames = {
                'reboot': 'REBOOT',
                'shutdown': 'SHUTDOWN',
                'restart_service': 'RESTART SERVICE',
                'lcd_init': 'REINIT LCD'
            };
            if (!confirm(`Send ${cmdNames[command] || command} to ${device}?`)) return;

            fetch(`/api/commands/${device}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({command})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(err => alert('Failed to send command: ' + err));
        }

        // Create turnstile card element
        function createTurnstileCard(moli) {
            const card = document.createElement('div');
            const statusClass = moli.status === 'locked' ? 'locked' : 'unlocked';
            const pistolActive = moli.pistol === 'On';
            const isOnline = moli.online;
            const health = moli.health || {};

            // Check for state change
            const prevState = previousState[moli.name];
            const hasChanged = prevState && (
                prevState.status !== moli.status ||
                prevState.pistol !== moli.pistol ||
                prevState.codes !== moli.codes
            );

            card.className = `turnstile-card ${statusClass}${hasChanged ? ' state-changed' : ''}${isOnline ? '' : ' offline'}`;
            card.innerHTML = `
                <div class="card-header">
                    <h3 class="card-title">${moli.name}</h3>
                    <span class="status-badge ${statusClass}">${moli.status}</span>
                </div>
                <div class="card-body">
                    <div class="card-row">
                        <span class="card-label">Pistol</span>
                        <span class="pistol-indicator ${pistolActive ? 'active' : ''}">
                            <span class="pistol-dot"></span>
                            ${moli.pistol}
                        </span>
                    </div>
                    <div class="card-row">
                        <span class="card-label">Codes</span>
                        <span class="codes-value">${moli.codes.toLocaleString()}</span>
                    </div>
                    <div class="health-indicators">
                        <span class="health-icon ${health.scanner ? 'ok' : 'error'}" title="Scanner ${health.scanner ? 'Connected' : 'Disconnected'}">&#128247;</span>
                        ${health.scanner_disconnects > 0 ? `<span class="health-warn" title="Disconnects: ${health.scanner_disconnects}, Reconnects: ${health.scanner_reconnects}">&#9888; ${health.scanner_disconnects}</span>` : ''}
                        <span class="health-icon ${health.display ? 'ok' : 'error'}" title="Display ${health.display ? 'Connected' : 'Disconnected'}">&#128421;</span>
                        <span class="health-icon ${health.network ? 'ok' : 'error'}" title="Network ${health.network ? 'OK' : 'Error'}">&#128246;</span>
                        ${health.cpu !== undefined ? `<span class="health-cpu" title="CPU Usage">${Math.round(health.cpu)}%</span>` : ''}
                        ${health.temperature ? `<span class="health-temp" title="Temperature">${health.temperature}&deg;C</span>` : ''}
                    </div>
                    ${health.last_seen ? `<div class="last-seen">Last seen: ${formatLastSeen(health.last_seen)}</div>` : ''}
                </div>
                <div class="card-actions">
                    <button onclick="sendCommand('${moli.name}', 'reboot')" title="Reboot Device">&#128260;</button>
                    <button onclick="sendCommand('${moli.name}', 'restart_service')" title="Restart Service">&#9654;</button>
                    <button onclick="sendCommand('${moli.name}', 'lcd_init')" title="Reinit LCD">&#128421;</button>
                    <button onclick="sendCommand('${moli.name}', 'shutdown')" class="btn-danger" title="Shutdown">&#9632;</button>
                </div>
            `;

            // Store current state
            previousState[moli.name] = {
                status: moli.status,
                pistol: moli.pistol,
                codes: moli.codes
            };

            return card;
        }

        // Update connection status
        function setConnectionStatus(connected, apiOnline, message = '') {
            const statusEl = document.getElementById('connection-status');
            const dot = statusEl.querySelector('.connection-dot');
            const text = statusEl.querySelector('.connection-text');

            if (connected) {
                dot.className = 'connection-dot connected';
                text.textContent = apiOnline ? 'Connected' : 'API Offline';
            } else {
                dot.className = 'connection-dot disconnected';
                text.textContent = message || 'Disconnected';
            }
        }

        // Fetch and render data
        function fetchData() {
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Network error');
                    return response.json();
                })
                .then(data => {
                    setConnectionStatus(true, data.apiOnline);
                    updateStats(data);

                    const grid = document.getElementById('turnstile-grid');
                    grid.innerHTML = '';

                    data.turnstiles.forEach(moli => {
                        const card = createTurnstileCard(moli);
                        grid.appendChild(card);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    setConnectionStatus(false, false, 'Connection Error');
                });
        }

        // Initial fetch and start polling
        fetchData();
        setInterval(fetchData, 1000);
    </script>
    <script>
        // Ticket search functionality
        const ticketInput = document.getElementById('ticket-search');
        const searchBtn = document.getElementById('search-btn');
        function validateTicket() {
            const ticketCode = ticketInput.value.trim();
            console.log(ticketCode);
            if (!ticketCode) return;

            fetch(`/api/ticket`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ticket: ticketCode})
            })
            .then(r => r.json())
            .then(data => {
                showTicketToast(data);
                if (data.status === 'success') {
                    flashDeviceCard(data.deviceName || data.device);
                }
                ticketInput.value = '';
                ticketInput.focus();
            })
            .catch(err => {
                showTicketToast({
                    status: 'error',
                    message: 'Failed to validate ticket',
                    deviceName: 'System'
                });
            });
        }

        searchBtn.addEventListener('click', validateTicket);
        ticketInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') validateTicket();
        });
    </script>
</body>
</html>
